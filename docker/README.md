# SSH Jump Server - Docker æµ‹è¯•ç¯å¢ƒ

å®Œæ•´çš„ Docker æµ‹è¯•ç¯å¢ƒï¼Œç”¨äºå¿«é€Ÿä½“éªŒå’Œæµ‹è¯• SSH Jump Serverã€‚

## æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Docker Network                              â”‚
â”‚                     (jump-network: 172.20.0.0/24)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚   â”‚   jump-client        â”‚  <-- SSH å®¢æˆ·ç«¯ï¼ˆç”¨æˆ·ï¼‰                 â”‚
â”‚   â”‚                      â”‚       ç”¨äºè¿æ¥è·³æ¿æœº                     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚              â”‚ SSH è¿æ¥ (port 2222)                                 â”‚
â”‚              â–¼                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚   â”‚   jump-server        â”‚  <-- SSH è·³æ¿æœºæœåŠ¡å™¨                   â”‚
â”‚   â”‚                      â”‚       ç«¯å£: 2222 (SSH), 8888 (Agent)    â”‚
â”‚   â”‚                      â”‚                                         â”‚
â”‚   â”‚  ç”¨æˆ·è®¤è¯:            â”‚                                         â”‚
â”‚   â”‚  - admin/admin123    â”‚                                         â”‚
â”‚   â”‚  - developer/dev123  â”‚                                         â”‚
â”‚   â”‚  - ops/ops123        â”‚                                         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚              â”‚ Agent åè®® (port 8888)                               â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚     â”‚        â”‚        â”‚         â”‚         â”‚                        â”‚
â”‚     â–¼        â–¼        â–¼         â–¼         â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚web-  â”‚â”‚api-  â”‚â”‚db-   â”‚ â”‚cache â”‚ â”‚      (ssh-jump-agent)        â”‚
â”‚  â”‚srv01 â”‚â”‚srv01 â”‚â”‚srv01 â”‚ â”‚-srv01â”‚ â”‚       æ¨¡æ‹Ÿç›®æ ‡æœåŠ¡å™¨           â”‚
â”‚  â”‚      â”‚â”‚      â”‚â”‚      â”‚ â”‚      â”‚ â”‚                               â”‚
â”‚  â”‚ SSH: â”‚â”‚ SSH: â”‚â”‚ SSH: â”‚ â”‚ SSH: â”‚ â”‚                               â”‚
â”‚  â”‚ 22   â”‚â”‚ 22   â”‚â”‚ 22   â”‚ â”‚ 22   â”‚ â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å®¹å™¨è¯´æ˜

| å®¹å™¨ | é•œåƒ | è¯´æ˜ |
|------|------|------|
| **jump-server** | ssh-jump-server | SSH è·³æ¿æœºï¼Œå¤„ç†ç”¨æˆ·è¿æ¥ã€Agent ç®¡ç†ã€æƒé™æ§åˆ¶ |
| **web-server-01** | ssh-jump-agent | Web æœåŠ¡å™¨ï¼Œæ‰€æœ‰ç”¨æˆ·å¯è®¿é—® |
| **api-server-01** | ssh-jump-agent | API æœåŠ¡å™¨ï¼Œæ‰€æœ‰ç”¨æˆ·å¯è®¿é—® |
| **db-server-01** | ssh-jump-agent | æ•°æ®åº“æœåŠ¡å™¨ï¼Œä»… admin å¯è®¿é—® |
| **cache-server-01** | ssh-jump-agent | ç¼“å­˜æœåŠ¡å™¨ï¼Œéæ•æ„Ÿèµ„äº§ |
| **jump-client** | ssh-jump-client | SSH å®¢æˆ·ç«¯ï¼Œç”¨äºæµ‹è¯• |

## å¿«é€Ÿå¼€å§‹

### ä¸€é”®å¯åŠ¨

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker compose up -d

# ç­‰å¾…æœåŠ¡å°±ç»ªï¼ˆçº¦ 10 ç§’ï¼‰
sleep 10

# æŸ¥çœ‹çŠ¶æ€
docker compose ps
```

### äº¤äº’å¼è¿æ¥

```bash
# æ–¹å¼1ï¼šä»å®¢æˆ·ç«¯å®¹å™¨è¿æ¥ï¼ˆæ¨èï¼‰
docker exec -it jump-client ssh -p 2222 admin@jump-server
# å¯†ç : admin123

# æ–¹å¼2ï¼šä»å®¿ä¸»æœºè¿æ¥ï¼ˆå¦‚æœç«¯å£æ˜ å°„ï¼‰
ssh -p 2222 admin@localhost
# å¯†ç : admin123

# æ–¹å¼3ï¼šè¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
docker exec jump-client /usr/local/bin/client-test.sh auto
```

## æ–°ç•Œé¢é¢„è§ˆ

è¿æ¥åçœ‹åˆ°å…¨æ–°çš„ JumpServer é£æ ¼ç•Œé¢ï¼š

```
SSH Jump Server - å®‰å…¨è®¿é—®ç½‘å…³

èµ„äº§åˆ—è¡¨
----------------------------------------------------------------------

  åºå·  ä¸»æœºå              IPåœ°å€           çŠ¶æ€
 --------------------------------------------------------------
  1   api-server-01       172.20.0.5        â—
  2   cache-server-01     172.20.0.6        â—
  3   db-server-01        172.20.0.3        â—
  4   web-server-01       172.20.0.4        â—

----------------------------------------------------------------------
  >
```

**ç•Œé¢ç‰¹ç‚¹ï¼š**
- âœ¨ ç®€æ´è®¾è®¡ï¼Œæ— å¤šä½™è£…é¥°
- ğŸ“Š 40% æ›´å¤šå‚ç›´ç©ºé—´ç”¨äºå†…å®¹
- ğŸ¨ å½©è‰²çŠ¶æ€æŒ‡ç¤ºï¼ˆâ— åœ¨çº¿ / â—‹ ç¦»çº¿ï¼‰
- ğŸ” æ¸…æ™°çš„è§†è§‰å±‚æ¬¡

## ç”¨æˆ·å‡­è¯

| ç”¨æˆ·å | å¯†ç  | è§’è‰² | å¯è®¿é—®èµ„äº§ |
|--------|------|------|-----------|
| admin | admin123 | ç®¡ç†å‘˜ | æ‰€æœ‰èµ„äº§ |
| developer | dev123 | å¼€å‘è€… | web-*, api-* |
| ops | ops123 | è¿ç»´ | web-*, api-*, cache-* |

## æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: åŸºæœ¬è¿æ¥

```bash
docker exec -it jump-client ssh -p 2222 admin@jump-server
# è¾“å…¥å¯†ç : admin123
# åº”è¯¥çœ‹åˆ° 4 ä¸ªèµ„äº§
```

### åœºæ™¯ 2: åºå·è¿æ¥

åœ¨èœå•ä¸­è¾“å…¥ `1` è¿æ¥åˆ° api-server-01ï¼š
```
> 1
æ­£åœ¨è¿æ¥åˆ° api-server-01 (172.20.0.5)...
è¿æ¥æˆåŠŸï¼æ­£åœ¨å»ºç«‹ä¼šè¯...
```

### åœºæ™¯ 3: æ¨¡ç³Šæœç´¢

```
> web
# è‡ªåŠ¨åŒ¹é…å¹¶è¿æ¥åˆ° web-server-01

> api
# è‡ªåŠ¨åŒ¹é…å¹¶è¿æ¥åˆ° api-server-01
```

### åœºæ™¯ 4: å‰ç¼€/åç¼€åŒ¹é…

```
> ^api
# åŒ¹é…ä»¥ api å¼€å¤´çš„ä¸»æœº

> $01
# åŒ¹é…ä»¥ 01 ç»“å°¾çš„ä¸»æœº
```

### åœºæ™¯ 5: æœ€è¿‘è®¿é—®

```
> @1
# å¿«é€Ÿè¿æ¥æœ€è¿‘è®¿é—®çš„ç¬¬ 1 ä¸ªæœåŠ¡å™¨
```

### åœºæ™¯ 6: æƒé™æµ‹è¯•

**å¼€å‘è€…ç”¨æˆ· - åªèƒ½çœ‹åˆ° web/apiï¼š**
```bash
docker exec -it jump-client ssh -p 2222 developer@jump-server
# å¯†ç : dev123
# é¢„æœŸ: åªæ˜¾ç¤º web-server-01 å’Œ api-server-01
```

**è¿ç»´ç”¨æˆ· - çœ‹ä¸åˆ° dbï¼š**
```bash
docker exec -it jump-client ssh -p 2222 ops@jump-server
# å¯†ç : ops123
# é¢„æœŸ: æ˜¾ç¤º web, api, cacheï¼Œä½†ä¸æ˜¾ç¤º db
```

### åœºæ™¯ 7: Exit è¿”å›èœå•

è¿æ¥åˆ°èµ„äº§åï¼š
```bash
root@api-server-01:~# exit
logout
# è‡ªåŠ¨è¿”å›è·³æ¿æœºèœå•ï¼Œæ˜¾ç¤ºæœ€è¿‘è®¿é—®
æœ€è¿‘: @1 api-server-01
```

## èœå•æ“ä½œé€ŸæŸ¥

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `1`-`9` | æŒ‰åºå·è¿æ¥ |
| `web` | æ¨¡ç³Šæœç´¢ |
| `^api` | å‰ç¼€åŒ¹é… |
| `$01` | åç¼€åŒ¹é… |
| `@1` | æœ€è¿‘è®¿é—® |
| `n`/`p` | ç¿»é¡µ |
| `r` | åˆ·æ–°åˆ—è¡¨ |
| `h` | å¸®åŠ© |
| `q` | é€€å‡º |

**è¿æ¥åï¼š**
| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `exit` | è¿”å›èœå• |
| `~.` | å¼ºåˆ¶æ–­å¼€ |

## å¸¸ç”¨å‘½ä»¤

### æŸ¥çœ‹çŠ¶æ€å’Œæ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker compose ps

# æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
docker compose logs -f jump-server

# æŸ¥çœ‹ Agent æ—¥å¿—
docker compose logs -f web-server-01

# æŸ¥çœ‹å®¢æˆ·ç«¯
docker compose logs -f jump-client
```

### ç®¡ç†æœåŠ¡

```bash
# é‡å¯æœåŠ¡
docker compose restart jump-server

# é‡å¯æ‰€æœ‰ Agent
docker compose restart web-server-01 api-server-01 db-server-01 cache-server-01

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker compose down

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker compose build --no-cache
docker compose up -d
```

### è¿›å…¥å®¹å™¨è°ƒè¯•

```bash
# è¿›å…¥è·³æ¿æœºæœåŠ¡å™¨
docker exec -it jump-server bash

# è¿›å…¥æŸä¸ª Agent
docker exec -it web-server-01 bash

# è¿›å…¥å®¢æˆ·ç«¯
docker exec -it jump-client bash
```

### å®Œæ•´æµ‹è¯•

```bash
# ä¸€é”®æ‰§è¡Œå®Œæ•´ E2Eï¼ˆæ„å»º + å¯åŠ¨ + è®¤è¯/æƒé™/ä¼šè¯/å­èŠ‚ç‚¹ CRUDï¼‰
./docker/test.sh

# ä»…è¿è¡Œå®¢æˆ·ç«¯è‡ªåŠ¨åŒ–æµ‹è¯•
docker exec jump-client /usr/local/bin/client-test.sh auto

# æˆ–æ‰‹åŠ¨æµ‹è¯•
docker exec -it jump-client bash
/usr/local/bin/client-test.sh
```

### å­èŠ‚ç‚¹ç®¡ç†ï¼ˆCRUDï¼‰

åœ¨å…¬ç½‘ç®¡ç†èŠ‚ç‚¹å®¹å™¨å†…ä½¿ç”¨ `ssh_jump_node_tool`ï¼š

```bash
# åˆ—è¡¨
docker exec jump-server ssh_jump_node_tool --list-nodes

# æ–°å¢
docker exec jump-server ssh_jump_node_tool --add-node edge-01 \
  --name "Edge 01" --public-address 203.0.113.10 --ssh-port 2222 --cluster-port 8888

# æŸ¥è¯¢
docker exec jump-server ssh_jump_node_tool --get-node edge-01

# æ›´æ–°
docker exec jump-server ssh_jump_node_tool --update-node edge-01 --description "updated" --disabled

# åˆ é™¤
docker exec jump-server ssh_jump_node_tool --delete-node edge-01
```

## é…ç½®æ–‡ä»¶

### Server é…ç½®
- é…ç½®ç›®å½•: `docker/server-config/config.conf`
- SSH ç«¯å£: 2222
- Agent ç«¯å£: 8888
- æ—¥å¿—çº§åˆ«: debug

### Agent é…ç½®
æ¯ä¸ª Agent é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼š
- `AGENT_ID`: å”¯ä¸€æ ‡è¯†ç¬¦
- `AGENT_TOKEN`: è®¤è¯ä»¤ç‰Œ
- `SERVER_HOST`: è·³æ¿æœºåœ°å€
- `SERVER_PORT`: è·³æ¿æœºç«¯å£ (8888)
- `AGENT_HOSTNAME`: æ˜¾ç¤ºåç§°
- `SSH_PORT`: SSH æœåŠ¡ç«¯å£ (22)

## ç«¯å£æ˜ å°„

| æœåŠ¡ | å®¹å™¨å†…ç«¯å£ | å®¿ä¸»æœºç«¯å£ | è¯´æ˜ |
|------|-----------|-----------|------|
| SSH | 2222 | 2222 | ç”¨æˆ·è¿æ¥ç«¯å£ |
| Agent | 8888 | 8888 | Agent æ³¨å†Œç«¯å£ |

## æ•…éšœæ’æŸ¥

### å®¹å™¨æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker compose logs jump-server

# æ£€æŸ¥ç«¯å£å ç”¨
ss -tlnp | grep -E '2222|8888'

# é‡æ–°æ„å»º
docker compose down
docker compose build --no-cache
docker compose up -d
```

### Agent æ— æ³•æ³¨å†Œ

```bash
# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
docker exec web-server-01 ping jump-server

# æ£€æŸ¥ Agent æ—¥å¿—
docker compose logs web-server-01

# æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—
docker compose logs jump-server | grep -i agent
```

### ç”¨æˆ·çœ‹ä¸åˆ°èµ„äº§

1. ç­‰å¾… Agent æ³¨å†Œï¼ˆçº¦ 10-15 ç§’ï¼‰
2. æ£€æŸ¥ç”¨æˆ·æƒé™é…ç½®
3. åˆ·æ–°èµ„äº§åˆ—è¡¨ï¼ˆè¾“å…¥ `r`ï¼‰

## æ›´æ–°æ—¥å¿—

### v2.0.0 (2025-02)
- âœ¨ å…¨æ–°ç®€æ´ç•Œé¢è®¾è®¡
- ğŸ› ä¿®å¤ exit åå¡ä½çš„é—®é¢˜
- âœ¨ æœ€è¿‘è®¿é—®è®°å½•åŠŸèƒ½
- ğŸ¨ å½©è‰²çŠ¶æ€æŒ‡ç¤º

## æ¸…ç†ç¯å¢ƒ

```bash
# åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰å®¹å™¨
docker compose down

# åˆ é™¤ç›¸å…³é•œåƒ
docker rmi ssh-jump-server ssh-jump-agent ssh-jump-client

# æ¸…ç†æœªä½¿ç”¨çš„ç½‘ç»œå’Œå·
docker network prune -f
docker volume prune -f
```

## ç›¸å…³é“¾æ¥

- [ä¸»README](../README.md) - é¡¹ç›®æ–‡æ¡£
- [å¿«é€Ÿå¼€å§‹](../docs/quickstart.md) - å¿«é€Ÿä¸Šæ‰‹æŒ‡å—
- [é…ç½®æŒ‡å—](../docs/configuration.md) - è¯¦ç»†é…ç½®è¯´æ˜
